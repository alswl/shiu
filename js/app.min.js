(function(){var a={UPDATE_FREQUENCY:7,init:function(){var b=this;b.ui=Object.create(window.shiu.ui.AppUi);b.ui.init(b);b.db=window.shiu.db.Db;b.bindOrientate()},run:function(){var b=this,c;b.ui.displayHeroUnit();if(!window.shiu.util.isMobile()&&!window.shiu.DEBUG){b.error("请在iPhone/iPod Touch打开")}else{if(window.navigator.standalone||window.shiu.util.isAndroid()||(window.shiu.DEBUG===true&&window.shiu.DEBUG_MODE==="standalone")){if(!b.loadBook()){b.error("书籍数据不存在，开始重新下载");b.downloadCallback=function(){window.location.reload()};b.download()}else{if(b.isNeedFetch()){b.checkUpdate()}b.info("请单击开始阅读",true);b.book=window.shiu.model.Book.init(b.loadBook());b.ui.displayStandalone()}}else{b.download()}}},downloadCallback:function(){},download:function(){var c=this,b=window.applicationCache,d,e;c.ui.displayDownload();b.ondownloading=function(){d=0};b.onprogress=function(g){var f="";if(g&&g.lengthComputable){f=Math.round(100*g.loaded/g.total)}else{d+=1;window.percent=Math.round(100*(d/8))}c.ui.updateDownloadPercent(f)};e=function(f){c.success("下载完成",true);c.saveBook(window.book);c.ui.updateDownloadComplete();c.downloadCallback();c.db.set("book_version",window.shiu.bookVersion);c.setNextFetchDate()};b.oncached=e;b.onnoupdate=e;b.onupdateready=e;c.loadBookJs()},startRead:function(){var b=this;b.ui.displayRead();b.ui.setChapter(b.book.getCurrentChapter().get$());b.ui.setPage(b.book.getCurrentPage());if(b.book.getCurrentPage()===0){b.book.setPageCount(b.ui.getPageCount())}},saveBook:function(b){this.db.set(window.bookTitle+"_book",b)},loadBook:function(){return this.db.get(window.bookTitle+"_book")},bindOrientate:function(){var b=this,c=false;window.addEventListener("orientationchange",function(d){if(Math.abs(window.orientation)!==0){b.error("人家还不会横屏处理啦，等以后的版本吧",true)}},false)},prePage:function(){var b=this;if(b.book.getCurrentPage()>0){b.book.setCurrentPage(b.book.getCurrentPage()-1);b.ui.setPage(b.book.getCurrentPage())}else{if(b.book.getCurrentChapterIndex()>0){b.preChapter()}else{return false}}return true},nextPage:function(){var b=this;if(b.book.getCurrentPage()<b.book.getPageCount()-1){b.book.setCurrentPage(b.book.getCurrentPage()+1);b.ui.setPage(b.book.getCurrentPage())}else{if(b.book.getCurrentChapterIndex()<b.book.chapters.length-1){b.nextChapter()}else{return false}}return true},preChapter:function(){var b=this;b.book.setCurrentChapterIndex(b.book.getCurrentChapterIndex()-1);b.setChapter()},nextChapter:function(){var b=this;b.book.setCurrentChapterIndex(b.book.getCurrentChapterIndex()+1);b.setChapter()},setChapter:function(){var b=this;b.book.setCurrentPage(0);b.ui.setChapter(b.book.getCurrentChapter().get$());b.book.setPageCount(b.ui.getPageCount());b.ui.setPage(0)},error:function(c,b){this.ui.alert(c,"error",b)},info:function(c,b){this.ui.alert(c,"info",b)},success:function(c,b){this.ui.alert(c,"success",b)},messageDisable:function(){this.ui.alert(null,"disable")},loadJs:function(b,d){var c=document.createElement("script");c.type="text/javascript";c.src=b;$("head")[0].appendChild(c);if(d!==undefined){c.onload=d}},loadBookJs:function(){this.loadJs("./book.min.js");this.loadJs("./version.js")},bindUpdate:function(){var b=this;b.loadJs("./version.js",function(){if(window.shiu.bookVersion>b.db.get("book_version")){if(window.confirm("有最新版本书籍数据更新")){b.ui.displayHeroUnit();b.downloadCallback=function(){window.location.reload()};b.download()}else{b.info("将在"+b.UPDATE_FREQUENCY+"天之后提醒您更新");b.setNextFetchDate()}}})},isNeedFetch:function(){var b=new Date();return b.getTime()>this.getNextFetchDate()},checkUpdate:function(c){var b=this;b.bindUpdate()},setNextFetchDate:function(){var b=this,c=new Date();c.setDate(c.getDate()+b.UPDATE_FREQUENCY);b.db.set("next_fetch_time",c.getTime())},getNextFetchDate:function(){var b=this;return b.db.get("next_fetch_time")}};window.shiu.App=a}());